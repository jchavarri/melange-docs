<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=3">
  <meta http-equiv="cleartype" content="on">
  <title>
   Dune integration — Melange.re
  </title>
  <link href="https://jchavarri.github.io/melange-docs/assets/styles/just-the-docs-default.css" rel="stylesheet">
  <link href="https://jchavarri.github.io/melange-docs/assets/styles/prism.css" rel="stylesheet">
  <link href="https://jchavarri.github.io/melange-docs/assets/styles/main.css" rel="stylesheet">
  <meta name="description" content="Melange is a mixture of tooling combined to produce JavaScript from OCaml &amp; Reason.">
 </head>
 <body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <symbol id="svg-link" viewbox="0 0 24 24">
    <title>
     Link
    </title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
     <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
     <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
    </svg>
   </symbol>
   <symbol id="svg-search" viewbox="0 0 24 24">
    <title>
     Search
    </title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
     <circle cx="11" cy="11" r="8"></circle>
     <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
   </symbol>
   <symbol id="svg-menu" viewbox="0 0 24 24">
    <title>
     Menu
    </title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
     <line x1="3" y1="12" x2="21" y2="12"></line>
     <line x1="3" y1="6" x2="21" y2="6"></line>
     <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
   </symbol>
   <symbol id="svg-arrow-right" viewbox="0 0 24 24">
    <title>
     Expand
    </title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
     <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
   </symbol>
   <symbol id="svg-doc" viewbox="0 0 24 24">
    <title>
     Document
    </title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
     <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
     <polyline points="13 2 13 9 20 9"></polyline>
    </svg>
   </symbol>
  </svg>
  <div class="side-bar">
   <div class="site-header">
    <a href="https://jchavarri.github.io/melange-docs/" class="site-title lh-tight">
        Melange.re </a> <a href="#" id="menu-button" class="site-button"> 
    <svg viewbox="0 0 24 24" class="icon">
     
          
     <use href="#svg-menu"></use>
     
        
    </svg>
     
   </a>
  </div>
  <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
   <ul class="nav-list">
    <li class="nav-list-item">
     <a href="https://jchavarri.github.io/melange-docs/intro" class="nav-list-link">Intro</a>
    </li>
    <li class="nav-list-item">
     <a href="https://jchavarri.github.io/melange-docs/installation" class="nav-list-link">Installation</a>
    </li>
    <li class="nav-list-item">
     <a href="#" class="nav-list-expander">
     <svg viewbox="0 0 24 24">
      <use href="#svg-arrow-right"></use>
     </svg>
    </a>
    <a href="https://jchavarri.github.io/melange-docs/interop" class="nav-list-link">Interop</a>
    <ul class="nav-list ">
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/cheatsheet" class="nav-list-link">Cheatsheet</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/embed-raw-javascript" class="nav-list-link">Embed Raw JavaScript</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/data-types" class="nav-list-link">Representation of Types</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/intro-to-external" class="nav-list-link">Intro to External</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/bind-to-global-values" class="nav-list-link">Bind to global values</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/null-undefined-option" class="nav-list-link">Null, Undefined &amp; Option</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/object" class="nav-list-link">Object</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/class" class="nav-list-link">Class</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/function" class="nav-list-link">Function</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/property-access" class="nav-list-link">Property access</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/import-export" class="nav-list-link">Import and export</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/regular-expression" class="nav-list-link">Regular expressions</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/exceptions" class="nav-list-link">Exceptions</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/json" class="nav-list-link">JSON</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/pipe-first" class="nav-list-link">Pipe first</a>
     </li>
     <li class="nav-list-item">
      <a href="https://jchavarri.github.io/melange-docs/interop/misc" class="nav-list-link">Miscellaneous</a>
     </li>
    </ul>
   </li>
   <li class="nav-list-item active">
    <a href="#" class="nav-list-expander">
    <svg viewbox="0 0 24 24">
     <use href="#svg-arrow-right"></use>
    </svg>
   </a>
   <a href="https://jchavarri.github.io/melange-docs/building" class="nav-list-link">Build system</a>
   <ul class="nav-list ">
    <li class="nav-list-item">
     <a href="https://jchavarri.github.io/melange-docs/building/bsb-differences" class="nav-list-link">ReScript <code>bsb</code> vs Melange <code>bsb</code></a>
    </li>
    <li class="nav-list-item active">
     <a href="https://jchavarri.github.io/melange-docs/building/dune-integration" class="nav-list-link active">Dune integration</a>
    </li>
    <li class="nav-list-item">
     <a href="https://jchavarri.github.io/melange-docs/building/generators" class="nav-list-link">Generators</a>
    </li>
    <li class="nav-list-item">
     <a href="https://jchavarri.github.io/melange-docs/building/virtual-libraries" class="nav-list-link">Virtual libraries</a>
    </li>
   </ul>
  </li>
  <li class="nav-list-item">
   <a href="https://jchavarri.github.io/melange-docs/standard-library" class="nav-list-link">Standard library</a>
  </li>
 </ul>
</nav>
<footer class="site-footer">
 This site uses a modified version of <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>,
      adapted for <a href="https://soupault.app">Soupault</a>.
</footer>
</div>
<div class="main" id="top">
<div id="main-header" class="main-header">
 <div class="search"></div>
 <div id="toggleSyntaxContainer" class="BtnGroup">
  <button class="btn BtnGroup-item btn-sm" type="button">re</button>
        <button class="btn BtnGroup-item btn-sm" type="button">ml</button>
 </div>
 <nav aria-label="Auxiliary" class="aux-nav">
  <ul class="aux-nav-list">
   <li class="aux-nav-list-item">
    <a href="https://github.com/melange-re/melange" class="site-button" target="_blank" rel="noopener noreferrer"> Melange on GitHub </a>
   </li>
  </ul>
 </nav>
</div>
<div id="main-content-wrap" class="main-content-wrap">
 <div id="content" class="main-content" role="main">
  <h1 id="dune-integration" data-nav-order="602">
   Dune integration
  </h1>
  <ol class="toc">
   <li>
    <a href="#dune-in-melange-vs-dune-in-ocaml">Dune in Melange vs Dune in OCaml</a>
   </li>
   <li>
    <a href="#working-on-projects-with-ocaml-and-melange">Working on projects with OCaml and Melange</a>
   </li>
   <ol class="toc">
    <li>
     <a href="#shared-folders-with-dirs-stanza">Shared folders with <code>dirs</code> stanza</a>
    </li>
    <li>
     <a href="#shared-dune-project">Shared <code>dune-project</code></a>
    </li>
    <li>
     <a href="#default-aliases-like--all">Default aliases like <code>@all</code></a>
    </li>
   </ol>
  </ol>
  <h2 id="dune-in-melange-vs-dune-in-ocaml">
   <a class="here" href="#dune-in-melange-vs-dune-in-ocaml">→ </a>Dune in Melange vs Dune in OCaml
  </h2>
  <p>
   One can be tempted to start adding <code>dune</code> files throughout folders in a Melange codebase, so that it starts compiling libraries, executables, etc. But this will not work, at least <em>yet</em>. The integration of Dune and Melange is not complete, and the features that Dune offers with Melage are a subset of all the features that this build system provides when used in standard OCaml projects.
  </p>
  <p>
   Dune in Melange is not used as OCaml build system, but as a low-level, custom rule build system. Melange generate rules that will call primitive commands like <code>bsc</code> and <code>bsb-helper</code>. It does this by leveraging Dune <a href="https://dune.readthedocs.io/en/stable/dune-files.html#rule"><code>rule</code></a> stanzas. But Dune does not recognize Melange modules or libraries as OCaml modules or libraries just yet, it blindly executes the rules defined in <code>dune.bsb</code>.
  </p>
  <p>
   So the approach to follow at the moment is <strong>to use <code>bsconfig.json</code> files as the mechanism to configure how a Melange project should build</strong>. In the future, there might be first class support for all the features that Dune support, once Dune understands how to build Melange sources.
  </p>
  <h2 id="working-on-projects-with-ocaml-and-melange">
   <a class="here" href="#working-on-projects-with-ocaml-and-melange">→ </a>Working on projects with OCaml and Melange
  </h2>
  <p>
   Considering the above, there are a couple of things to keep in mind:
  </p>
  <ol>
   <li>
    As all Dune rules generated by Melange are placed in a separate <code>dune.bsb</code> file, and will run only under <code>@bsb_world</code> alias, they should not interfere with native OCaml builds.
   </li>
   <li>
    All existing <code>dune</code> files in a codebase will be ignored by Melange, so they should not interfere with Melange builds (unless they are in shared code folders, see more below).
   </li>
  </ol>
  <p>
   In most situations, OCaml and Melange builds should not interfere with each other, as the sources are placed in different folders. But there are situations where existing Dune configurations for OCaml native applications might interfere with Melange.
  </p>
  <p>
   Here is a list with some of the most common cases:
  </p>
  <h3 id="shared-folders-with-dirs-stanza">
   <a class="here" href="#shared-folders-with-dirs-stanza">→ </a>Shared folders with <code>dirs</code> stanza
  </h3>
  <p>
   If a shared code folder is part of the Melange build and there is a <code>dune</code> file in it with <code>(dirs ...)</code> stanza, then Melange will try to build sources that are part of the native build. This will most likely fail. One solution might be to remove the <code>dirs</code> stanza and create new libraries for the folders that were included with <code>dirs</code>, then add them to the <code>libraries</code> stanza in the shared folder <code>dune</code> file.
  </p>
  <h3 id="shared-dune-project">
   <a class="here" href="#shared-dune-project">→ </a>Shared <code>dune-project</code>
  </h3>
  <p>
   The Dune project file might need to be lifted to a shared folder above Melange and OCaml sources, and updated to at least Dune 2.7, the first version supported by Melange.
  </p>
  <h3 id="default-aliases-like--all">
   <a class="here" href="#default-aliases-like--all">→ </a>Default aliases like <code>@all</code>
  </h3>
  <p>
   If you try to run <code>dune build @all</code> or other default aliases from the Melange installation, you might get errors due to native libraries not being available, or native code not being compilable. Make sure to only run <code>dune build @bsb_world</code> when building Melange.
  </p>
  <p>
   In the same way, if you try to run <code>dune build @all</code> from a standard OCaml installation that coexists with Melange, then the <code>@bsb_world</code> alias will be included in the build, and fail. Note this will only happen if both OCaml and Melange are using version 4.12 of the compiler, as all the rules generated by Melange only run on this version though a <code>enabled_if</code> stanza.
  </p>
 </div>
</div>
<div class="search-overlay"></div>
</div>
<script>
function openLangTab(evt, langClassName) {
      evt.stopPropagation();
      evt.preventDefault();
      var i, tabcontent, tablinks;
      var target = evt.currentTarget;
      tabcontents = target.parentNode.nextElementSibling.querySelectorAll("code");
      tabcontents.forEach(function (tabcontent) {
        tabcontent.style.display = "none";
      });
      tablinks = target.parentNode.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      target.parentNode.nextElementSibling.getElementsByClassName(langClassName)[0].style.display = "block";
      evt.currentTarget.className += " active";
      return false;
    }
    Array.from(document.getElementsByClassName("button-language-ocaml")).forEach(function (element) { element.click(); });
</script>
<script>
// Toggle syntax button
    document.addEventListener('DOMContentLoaded', () => {
      const SYNTAXES = ['reason', 'ocaml']
      const CLASS_PREFIX = 'syntax__'
      
      const container = document.querySelector('#toggleSyntaxContainer');
      const re = container.children[0];
      const ml = container.children[1];
      re.addEventListener("click", () => {
        setCurrentSyntax("reason");
      });
      ml.addEventListener("click", () => {
        setCurrentSyntax("ocaml");
      });

      let currentSyntax
      let setCurrentSyntax = (syntax = SYNTAXES[0]) => {
        document.body.classList.remove(`${CLASS_PREFIX}${currentSyntax}`)
        document.body.classList.add(`${CLASS_PREFIX}${syntax}`)
        for (let i = 0; i < container.children.length; i++) {
          container.children[i].classList.remove(`selected`);
        }
        if (syntax === "reason") {
          re.classList.add(`selected`)
        } else {
          ml.classList.add(`selected`)
        }
        Array.from(document.getElementsByClassName(`button-language-${syntax}`)).forEach(function (element) { element.click(); });

        currentSyntax = syntax
        localStorage.setItem('syntax', currentSyntax)
      }

      setCurrentSyntax(localStorage.getItem('syntax', currentSyntax) || SYNTAXES[0])
    })
</script>
<script src="https://jchavarri.github.io/melange-docs/assets/js/just-the-docs.js" type="text/javascript"></script>
</body>
</html>
