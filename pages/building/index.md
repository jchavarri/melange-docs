<h1 data-nav-order="51">Build system</h1>

One of the main differences between Melange and ReScript, and a relevant reason for Melange to become a separate project, is the replacement of the build system.

Melange attempts to be as compatible as possible with OCaml, while keeping compatibility with existing ReScript projects. To fulfill that goal, Melange replaces almost completely the implementation of `bsb`, the ReScript build tool. The new implementation in Melange relies on [Dune](https://dune.build/), a composable build system for OCaml, to take care of the most intricate parts of the build process.

In this section, we will:
- give an overview of the build system in ReScript,
- then see how Melange build system works and the differences with ReScript,
- and finally how Dune configurations differ between standard OCaml projects and Melange.

## Calling `bsb -make-world` in ReScript

ReScript build configurations are specified in a `bsconfig.json` file, that is added to the project root folder.

This file is used by ReScript build tool, called `bsb`. `bsb` itself is a fork of [Ninja](https://ninja-build.org/). When a ReScript user runs `bsb -make-world`, the build tool will read the `bsconfig.json` file, then the folders and files that are part of the project, and then generate all the build rules that are written to a file called `build.ninja`. This file can be found under the `lib/bs` folder.

At the end of the build process, ReScript will defer to Ninja to know which rules should be executed, which ones can be parallelized, and then execute them.

## Calling `bsb -make-world` in Melange

Melange keeps all user-facing interfaces compatible with ReScript. For the build system, this means preserving `bsconfig.json` as the way to describe how an application should be built.

However, Melange replaces `bsb` behavior almost completely. When a Melange user runs `bsb -make-world`, instead of generating rules in a format that Ninja can understand —like ReScript does—, Melange version of `bsb` will generate rules in a format that Dune can understand. Instead of generating a `build.ninja` file, Melange `bsb` generates a `dune.bsb` file using Dune [stanzas](https://dune.readthedocs.io/en/stable/dune-files.html#stanza-reference).

After this `dune.bsb` file has been generated, the second part of `bsb -make-world` is to run the `dune build @bsb_world` command, which happens implicitly. This command leverages Dune [aliases](https://dune.readthedocs.io/en/stable/dune-files.html#alias) to build exclusively the rules that have been generated from the `bsconfig.json` file, and not more. At the point where this command is called, Melange defers to Dune the execution of these rules, the same way ReScript defers to Ninja, so the same kind of optimizations can be performed: incremental builds, parallelization, etc.

In subsequent builds, users can decide to not call `bsb -make-world` and instead call `dune build @bsb_world` directly, to skip the `dune.bsb` file creation step if the original `bsconfig.json` has not changed.

## Dune in Melange vs Dune in OCaml

One can be tempted to start adding `dune` files throughout folders in a Melange codebase, so that it starts compiling libraries, executables, etc. But this will not work, at least _yet_. The integration of Dune and Melange is not complete, and the features that Dune offers with Melage are a subset of all the features that this build system provides when used in standard OCaml projects.

Dune in Melange is not used as OCaml build system, but as a low-level, custom rule build system. Melange generate rules that will call primitive commands like `bsc` and `bsb-helper`. It does this by leveraging Dune [`rule`](https://dune.readthedocs.io/en/stable/dune-files.html#rule) stanzas. But Dune does not recognize Melange modules or libraries as OCaml modules or libraries just yet, it blindly executes the rules defined in `dune.bsb`.

So the approach to follow at the moment is **to use `bsconfig.json` files as the mechanism to configure how a Melange project should build**. In the future, there might be first class support for all the features that Dune support, once Dune understands how to build Melange sources.

## Working on projects with OCaml and Melange

Considering the above, there are a couple of things to keep in mind:

1. As all Dune rules generated by Melange are placed in a separate `dune.bsb` file, and will run only under `@bsb_world` alias, they should not interfere with native OCaml builds.
2. All existing `dune` files in a codebase will be ignored by Melange, so they should not interfere with Melange builds (unless they are in shared code folders, see more below).

In most situations, OCaml and Melange builds should not interfere with each other, as the sources are placed in different folders. But there are situations where existing Dune configurations for OCaml native applications might interfere with Melange.

Here is a list with some of the most common cases:

### Shared folders with `dirs` stanza

If a shared code folder is part of the Melange build and there is a `dune` file in it with `(dirs ...)` stanza, then Melange will try to build sources that are part of the native build. This will most likely fail. One solution might be to remove the `dirs` stanza and create new libraries for the folders that were included with `dirs`, then add them to the `libraries` stanza in the shared folder `dune` file.

### Shared `dune-project`

The Dune project file might need to be lifted to a shared folder above Melange and OCaml sources, and updated to at least Dune 2.7, the first version supported by Melange.

### Default aliases like `@all`

If you try to run `dune build @all` or other default aliases from the Melange installation, you might get errors due to native libraries not being available, or native code not being compilable. Make sure to only run `dune build @bsb_world` when building Melange.

In the same way, if you try to run `dune build @all` from a standard OCaml installation that coexists with Melange, then the `@bsb_world` alias will be included in the build, and fail. Note this will only happen if both OCaml and Melange are using version 4.12 of the compiler, as all the rules generated by Melange only run on this version though a `enabled_if` stanza.