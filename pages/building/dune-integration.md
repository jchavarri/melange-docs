<h1 data-nav-order="602">Dune integration</h1>

## Dune in Melange vs Dune in OCaml

One can be tempted to start adding `dune` files throughout folders in a Melange codebase, so that it starts compiling libraries, executables, etc. But this will not work, at least _yet_. The integration of Dune and Melange is not complete, and the features that Dune offers with Melage are a subset of all the features that this build system provides when used in standard OCaml projects.

Dune in Melange is not used as OCaml build system, but as a low-level, custom rule build system. Melange generate rules that will call primitive commands like `bsc` and `bsb-helper`. It does this by leveraging Dune [`rule`](https://dune.readthedocs.io/en/stable/dune-files.html#rule) stanzas. But Dune does not recognize Melange modules or libraries as OCaml modules or libraries just yet, it blindly executes the rules defined in `dune.bsb`.

So the approach to follow at the moment is **to use `bsconfig.json` files as the mechanism to configure how a Melange project should build**. In the future, there might be first class support for all the features that Dune support, once Dune understands how to build Melange sources.

## Working on projects with OCaml and Melange

Considering the above, there are a couple of things to keep in mind:

1. As all Dune rules generated by Melange are placed in a separate `dune.bsb` file, and will run only under `@bsb_world` alias, they should not interfere with native OCaml builds.
2. All existing `dune` files in a codebase will be ignored by Melange, so they should not interfere with Melange builds (unless they are in shared code folders, see more below).

In most situations, OCaml and Melange builds should not interfere with each other, as the sources are placed in different folders. But there are situations where existing Dune configurations for OCaml native applications might interfere with Melange.

Here is a list with some of the most common cases:

### Shared folders with `dirs` stanza

If a shared code folder is part of the Melange build and there is a `dune` file in it with `(dirs ...)` stanza, then Melange will try to build sources that are part of the native build. This will most likely fail. One solution might be to remove the `dirs` stanza and create new libraries for the folders that were included with `dirs`, then add them to the `libraries` stanza in the shared folder `dune` file.

### Shared `dune-project`

The Dune project file might need to be lifted to a shared folder above Melange and OCaml sources, and updated to at least Dune 2.7, the first version supported by Melange.

### Default aliases like `@all`

If you try to run `dune build @all` or other default aliases from the Melange installation, you might get errors due to native libraries not being available, or native code not being compilable. Make sure to only run `dune build @bsb_world` when building Melange.

In the same way, if you try to run `dune build @all` from a standard OCaml installation that coexists with Melange, then the `@bsb_world` alias will be included in the build, and fail. Note this will only happen if both OCaml and Melange are using version 4.12 of the compiler, as all the rules generated by Melange only run on this version though a `enabled_if` stanza.